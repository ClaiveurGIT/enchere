<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Plateforme d'Enchères Sécurisées</title>
</head>
<body>
    <h1>Bienvenue sur la Plateforme d'Enchères Sécurisées</h1>

    <div id="auth">
        <h2>Inscription</h2>
        <input type="text" id="reg-username" placeholder="Nom d'utilisateur">
        <input type="password" id="reg-password" placeholder="Mot de passe">
        <button onclick="register()">S'inscrire</button>

        <h2>Connexion</h2>
        <input type="text" id="login-username" placeholder="Nom d'utilisateur">
        <input type="password" id="login-password" placeholder="Mot de passe">
        <button onclick="login()">Se connecter</button>
    </div>

    <div id="auction" style="display:none;">
        <h2>Soumettre une Offre</h2>
        <input type="number" id="offer" placeholder="Votre offre">
        <button onclick="submitOffer()">Soumettre l'offre</button>
        <h3>Temps restant : <span id="timer"></span></h3>
    </div>

    <script>
    function register() {
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;

        fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        })
        .then(response => response.json())
        .then(data => alert(data.message));
    }

    function login() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;

        fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.status === 'success') {
                document.getElementById('auth').style.display = 'none';
                document.getElementById('auction').style.display = 'block';
                startTimer();
            }
        });
    }

    function submitOffer() {
        const offer = document.getElementById('offer').value;
        const aes_key = btoa(crypto.getRandomValues(new Uint8Array(32)).toString());
        const hmac_value = btoa(crypto.getRandomValues(new Uint8Array(32)).toString());

        fetch('/bid', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ offer, aes_key, hmac: hmac_value })
        })
        .then(response => response.json())
        .then(data => alert(data.message));
    }

    function startTimer() {
        setInterval(() => {
            fetch('/get_timer')
                .then(response => response.json())
                .then(data => {
                    const timer = document.getElementById('timer');
                    const time_remaining = data.time_remaining;

                    const minutes = Math.floor(time_remaining / 60);
                    const seconds = time_remaining % 60;

                    timer.innerHTML = `${minutes}m ${seconds}s`;

                    if (time_remaining <= 0) {
                        timer.innerHTML = "Enchère terminée";
                    }
                });
        }, 1000);
    }
    </script>
</body>
</html>